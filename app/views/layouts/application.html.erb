<!DOCTYPE html>
<html>
  <head>
    <title>TypingApp</title>
    <%= csrf_meta_tags %>
    <%= stylesheet_link_tag    'application', media: 'all' %>
    <%= javascript_include_tag 'application' %>
  </head>
  <body>
    <div class="container-fluid">

      <%= yield %>

      <div id="type-console">
        <%= render 'partials/main' %>

        <div v-show="stats">

          <div class="alert alert-info" role="alert">
            {{ statsMsg }} <br> {{ userSpeedMsq }} <br> {{ computerSpeedMsg }} <br>

          </div>
            Press <strong>any Key</strong> to continue

        </div>

        <div v-show="finishExercise">
          <div class="alert alert-success" role="alert">
            <strong>Awesome!</strong> You are finished with this section.
            <br>
          </div>
        </div>
      </div>

    </div>
  </body>


  <script>

var typeConsole = new Vue({
  el: '#type-console',
  data: {
    bookId: <%= @book_id %>,
    pageIds: <%= @book_page_ids %>,
    pagesSize: <%= @book_page_ids.size %>,
    pageCounter: 0,
    currentPercentage: '0%',
    content: "",
    stats: false,
    statsMsg: "",
    userSpeedMsq: "",
    computerSpeedMsg: "",
    finishExercise: "",
    compete: (localStorage.compete || false),
    userNotFinished: true,
    userFinished: ! this.userNotFinished
  },
  created: function(){
    this.fetchPageContent();
  },
  computed: {
    computePagePercentage: function(){
      return this.currentPercentage = String(Math.round(this.pageCounter / this.pagesSize * 100)) + '%';
    }

  },
  methods: {
    competeToggle: function(){
      this.compete = ! this.compete;
      localStorage.setItem("compete", this.compete);
    },
    fetchPageContent: function(){
      if (this.pageIds.length > 0) {
        this.$http.get(`/books/${this.bookId}/book_pages/${this.pageIds.shift()}.json`).then((response) => {
          this.typingConsole(response.data.page_content);
        }, (response) => {
          alert("We had trouble loading content. Please reload the page.")
        });
      } else {
        this.finishExercise = true;
      }
    },
    typingConsole: function(text) {
      vm = this;
      var charPointer           = 0;
      var errors                = 0;
      var charIndex             = 0;
      var textLength            = text.length;
      var textInSpanWithIds     = "";
      var chars                 = text.split("");
      var defaultWordPerMinute  = 50;
      var computerWordPerMinute = localStorage.userWPM || defaultWordPerMinute;
      var toCharacter           = 5;
      var pageUrl               = window.location.href;
      var currentCharacter;

      var computerTimeout = function(wordPerMinute) {
        let secondsInMinute      = 60;
        let millisecundsInSecond = 1000;
        return secondsInMinute * millisecundsInSecond / wordPerMinute;
      }

      var computerDelayTime = computerTimeout(computerWordPerMinute * toCharacter);

      // this is parsing text and giving it spans
      for(let i=0; i<textLength; i++) {
        if ((text[i] === "\n") || text[i] === "\r") {
          textInSpanWithIds += text[i]
        }else if (((text[i] === " ") && (text[i-1] === " ")) || ((text[i] === " ") && (text[i-1] == "\n"))) {
          textInSpanWithIds += text[i]
        } else {
          textInSpanWithIds += `<span id="char-${charIndex}">${text[i]}</span>`;
          charIndex++;
        }
      }

      var lastSpanIndex = charIndex;
      var computerIndex = 0;
      var timeouts = [];

      document.getElementById("text").innerHTML = textInSpanWithIds;
      document.getElementById("char-0").className += "cursor";

      var computerBackgroundHighlighter = function(e) {
        timeouts.push(setTimeout(function(){
          if(computerIndex < lastSpanIndex && vm.userNotFinished) {

            if(e.type === 'keypress') {
              document.getElementById(`char-${computerIndex}`).className += ' computer';
              computerIndex++;
              computerBackgroundHighlighter(e);
            }
          }
        }, computerDelayTime))
      }

      var timer = {};

      var checkOnKeypress = function(event) {
        // execute computerBackgroundHighlighter only when first key is pressed
        if (charPointer === 0) {
          timer.startTimer = new Date().getTime();

          if (vm.compete === "true" || vm.compete === true) { computerBackgroundHighlighter(event); }
        }

        if (charPointer < lastSpanIndex) {

          let userKeyCode       = event.which;
          let userChar          = String.fromCharCode(userKeyCode);
          currentCharacter      = document.getElementById(`char-${charPointer}`).innerHTML;

          // handles chrome weird 'space' hijacking
          var previousChar = function(){ return charPointer ?  document.getElementById(`char-${charPointer-1}`).innerHTML : document.getElementById(`char-${charPointer}`).innerHTML; };
          let previousCharacter = previousChar();
          if (event.type == 'keypress') {
            if((userChar === ' ') && previousCharacter === ' ') { return }
          } else {
            if(!((userChar === ' ') && (currentCharacter === ' '))) {
              return;
            }
          }

          // removes currsor highlighter
          currentClasses = document.getElementById(`char-${charPointer}`).className;
          document.getElementById(`char-${charPointer}`).className = currentClasses.replace("cursor", "");

          // highlights correct/wrong user input
          if (userChar === currentCharacter) {
            document.getElementById(`char-${charPointer}`).className += " right-char";

          } else {
            let currentSpanCharacter = document.getElementById(`char-${charPointer}`);
            currentSpanCharacter.className += " wrong-char";

            if (currentSpanCharacter.innerHTML === " ") {
              currentSpanCharacter.innerHTML = "_";
            }
            errors++
          }
        }

        // calculate times and display stats
        if ((charPointer+1) === lastSpanIndex) {
          // clear (setTimeout) parallel highlighting from previous page
          vm.userNotFinished = false;
          for (var i = 0; i < timeouts.length; i++) {
            clearTimeout(timeouts[i]);
          }
          timeouts = [];

          timer.endTimer         = new Date().getTime();
          let timeToFinishTyping = (timer.endTimer - timer.startTimer) / 1000;
          let numOfChar          = lastSpanIndex;
          let minute             = 60;
          let charsPerMinute     = (numOfChar * 60) / timeToFinishTyping;
          let wordsPerMinute     = Math.round(charsPerMinute / toCharacter);

          localStorage.setItem("userWPM", wordsPerMinute);

          // display stats
          vm.pageCounter += 1;
          vm.stats            = true;
          vm.statsMsg         = `You typed ${(lastSpanIndex)-errors} characters correctly and typed ${errors} characters incorectly!`;
          vm.userSpeedMsq     = `Your speed: ${wordsPerMinute} words per minute!`;
          vm.computerSpeedMsg = `Computer speed: ${computerWordPerMinute} `;
        } else if ((charPointer) == lastSpanIndex) {
          vm.userNotFinished     = true;
          typeConsole.fetchPageContent();
          vm.stats = "";
        } else if ((charPointer+1) > lastSpanIndex) {
          return;
        }
        charPointer += 1;

        // adds currsor highlighter to next character
        if (charPointer < lastSpanIndex) {
          document.getElementById(`char-${charPointer}`).className += " cursor"
        }
      }

      document.body.addEventListener('keypress', checkOnKeypress);
      document.body.addEventListener('keydown', checkOnKeypress);
    }
  }
})

  </script>
</html>
